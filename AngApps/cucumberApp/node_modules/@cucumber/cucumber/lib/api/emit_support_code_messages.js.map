{"version":3,"file":"emit_support_code_messages.js","sourceRoot":"","sources":["../../src/api/emit_support_code_messages.ts"],"names":[],"mappings":"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","sourcesContent":["import { EventEmitter } from 'node:events'\nimport os from 'node:os'\nimport * as messages from '@cucumber/messages'\nimport { Envelope, HookType, IdGenerator } from '@cucumber/messages'\nimport detectCiEnvironment from '@cucumber/ci-environment'\nimport { SupportCodeLibrary } from '../support_code_library_builder/types'\nimport { version } from '../version'\nimport { ILineAndUri } from '../types'\n\ninterface OrderedEnvelope {\n  order: number\n  envelope: messages.Envelope\n}\n\nexport async function emitMetaMessage(\n  eventBroadcaster: EventEmitter,\n  env: NodeJS.ProcessEnv\n): Promise<void> {\n  const meta: messages.Meta = {\n    protocolVersion: messages.version,\n    implementation: {\n      version,\n      name: 'cucumber-js',\n    },\n    cpu: {\n      name: os.arch(),\n    },\n    os: {\n      name: os.platform(),\n      version: os.release(),\n    },\n    runtime: {\n      name: 'node.js',\n      version: process.versions.node,\n    },\n    ci: detectCiEnvironment(env),\n  }\n  eventBroadcaster.emit('envelope', {\n    meta,\n  })\n}\n\nfunction makeSourceReference(source: ILineAndUri) {\n  return {\n    uri: source.uri,\n    location: {\n      line: source.line,\n    },\n  }\n}\n\nfunction extractPatternSource(pattern: string | RegExp) {\n  if (pattern instanceof RegExp) {\n    return pattern.flags ? pattern.toString() : pattern.source\n  }\n  return pattern\n}\n\nfunction collectParameterTypeEnvelopes(\n  supportCodeLibrary: SupportCodeLibrary,\n  newId: IdGenerator.NewId\n): ReadonlyArray<OrderedEnvelope> {\n  const ordered: Array<OrderedEnvelope> = []\n  for (const parameterType of supportCodeLibrary.parameterTypeRegistry\n    .parameterTypes) {\n    if (parameterType.builtin) {\n      continue\n    }\n    const source =\n      supportCodeLibrary.parameterTypeRegistry.lookupSource(parameterType)\n    ordered.push({\n      order: source.order,\n      envelope: {\n        parameterType: {\n          id: newId(),\n          name: parameterType.name,\n          preferForRegularExpressionMatch: parameterType.preferForRegexpMatch,\n          regularExpressions: parameterType.regexpStrings,\n          useForSnippets: parameterType.useForSnippets,\n          sourceReference: makeSourceReference(source),\n        },\n      },\n    })\n  }\n  return ordered\n}\n\nfunction collectStepDefinitionEnvelopes(\n  supportCodeLibrary: SupportCodeLibrary\n): ReadonlyArray<OrderedEnvelope> {\n  return supportCodeLibrary.stepDefinitions.map((stepDefinition) => ({\n    order: stepDefinition.order,\n    envelope: {\n      stepDefinition: {\n        id: stepDefinition.id,\n        pattern: {\n          source: extractPatternSource(stepDefinition.pattern),\n          type:\n            typeof stepDefinition.pattern === 'string'\n              ? messages.StepDefinitionPatternType.CUCUMBER_EXPRESSION\n              : messages.StepDefinitionPatternType.REGULAR_EXPRESSION,\n        },\n        sourceReference: makeSourceReference(stepDefinition),\n      },\n    },\n  }))\n}\n\nfunction collectHookEnvelopes(\n  supportCodeLibrary: SupportCodeLibrary\n): ReadonlyArray<OrderedEnvelope> {\n  const allHooks = [\n    [\n      supportCodeLibrary.beforeTestCaseHookDefinitions,\n      HookType.BEFORE_TEST_CASE,\n    ] as const,\n    [\n      supportCodeLibrary.afterTestCaseHookDefinitions,\n      HookType.AFTER_TEST_CASE,\n    ] as const,\n    [\n      supportCodeLibrary.beforeTestRunHookDefinitions,\n      HookType.BEFORE_TEST_RUN,\n    ] as const,\n    [\n      supportCodeLibrary.afterTestRunHookDefinitions,\n      HookType.AFTER_TEST_RUN,\n    ] as const,\n  ]\n  const ordered: Array<OrderedEnvelope> = []\n  allHooks.forEach(([hooks, type]) => {\n    hooks.forEach((hook) => {\n      ordered.push({\n        order: hook.order,\n        envelope: {\n          hook: {\n            id: hook.id,\n            type,\n            name: hook.name,\n            ...('tagExpression' in hook && {\n              tagExpression: hook.tagExpression,\n            }),\n            sourceReference: makeSourceReference(hook),\n          },\n        } satisfies Envelope,\n      })\n    })\n  })\n  return ordered\n}\n\nexport function emitSupportCodeMessages({\n  eventBroadcaster,\n  supportCodeLibrary,\n  newId,\n}: {\n  eventBroadcaster: EventEmitter\n  supportCodeLibrary: SupportCodeLibrary\n  newId: IdGenerator.NewId\n}): void {\n  const orderedEnvelopes = [\n    ...collectParameterTypeEnvelopes(supportCodeLibrary, newId),\n    ...collectStepDefinitionEnvelopes(supportCodeLibrary),\n    ...collectHookEnvelopes(supportCodeLibrary),\n  ]\n  orderedEnvelopes\n    .sort((a, b) => a.order - b.order)\n    .forEach(({ envelope }) => eventBroadcaster.emit('envelope', envelope))\n\n  supportCodeLibrary.undefinedParameterTypes\n    .map((undefinedParameterType) => ({\n      undefinedParameterType,\n    }))\n    .forEach((envelope) => eventBroadcaster.emit('envelope', envelope))\n}\n"]}